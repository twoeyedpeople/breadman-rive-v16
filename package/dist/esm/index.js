"use client"
import{createContext as St,useContext as kt}from"react";import{useEffect as dt,useMemo as ft,useState as pt}from"react";import{Alignment as ht,Fit as Ct,Layout as gt}from"@rive-app/react-canvas";import{useCallback as Oe,useState as lt}from"react";import{decodeImage as ut,useRive as mt}from"@rive-app/react-canvas";function Te(e,r){let[n,t]=lt(new Set),o=mt({...e,assetLoader:(s,i)=>e!=null&&e.assetLoader&&e.assetLoader(s,i)?!0:i.length>0||s.cdnUuid.length>0?!1:s.isImage?(t(C=>{let p=new Set(C);return p.add(s),p}),!0):!1},r),a=Oe((s,i)=>{if(!s)throw new Error("ImageAsset is not available.");fetch(i).then(async C=>{console.log("doing this");let p=await ut(new Uint8Array(await C.arrayBuffer()));s.setRenderImage(p),p.unref()})},[]),d=Oe((s,i)=>{let C=Array.from(n).find(p=>p.name===s);return a(C,i)},[n]);return{...o,setImageAsset:d}}var Ne=(e,r)=>{let[n,t]=pt(!1),o=ft(()=>({artboard:"Character",animations:"IDLE",stateMachines:e,autoplay:!0,shouldDisableRiveListeners:!0,layout:new gt({fit:Ct.Contain,alignment:ht.TopCenter}),onLoad:()=>t(!0),onLoadError:i=>process.env.NODE_ENV!=="production"&&console.warn(i),...r}),[e,r==null?void 0:r.src]),{rive:a,RiveComponent:d,setImageAsset:s}=Te(o,{shouldResizeCanvasToContainer:!0});return dt(()=>{!a||a.load(o)},[o.src]),{rive:a,isRiveLoaded:n,RiveComponent:d,setImageAsset:s}};var Q="https://zmq5pgrp8hzedcr4.public.blob.vercel-storage.com",l="InLesson",le={0:100,1:101,2:102,3:104,4:103,5:114,6:105,7:110,8:112,9:103,10:110,11:101,12:118,13:114,14:108,15:113,16:115,17:116,18:109,19:116,20:118,21:107},oe=21,xe=42,we=2,$e={value:null,fire:()=>{}};var zn={cat:{riv:`${Q}/avatars/Cat.riv`,background:`${Q}/backgrounds/jungle.jpg`,cover:`${Q}/avatars/cat.png`},cyber_girl:{riv:`${Q}/avatars/Cyber_Girl.riv`,background:`${Q}/backgrounds/cyberpunk.jpg`,cover:`${Q}/avatars/cyber_girl.png`},panda:{riv:`${Q}/avatars/Panda.riv`,background:`${Q}/backgrounds/panda.jpg`,cover:`${Q}/avatars/panda.png`}};import{useStateMachineInput as vt}from"@rive-app/react-canvas";var u=(e,r,n,t)=>{var o;return(o=vt(e,r,n,t))!=null?o:$e};var Ue=({rive:e,customInputNames:r})=>{let n=le,t=u(e,l,"is_speaking"),o=u(e,l,"eyes_smile"),a={100:u(e,l,"100"),101:u(e,l,"101"),102:u(e,l,"102"),103:u(e,l,"103"),104:u(e,l,"104"),105:u(e,l,"105"),107:u(e,l,"107"),108:u(e,l,"108"),109:u(e,l,"109"),110:u(e,l,"110"),112:u(e,l,"112"),113:u(e,l,"113"),114:u(e,l,"114"),115:u(e,l,"115"),116:u(e,l,"116"),118:u(e,l,"118"),is_speaking:u(e,l,"is_speaking"),eyes_smile:u(e,l,"eyes_smile")},d={mouth:{100:u(e,l,"100"),101:u(e,l,"101"),102:u(e,l,"102"),103:u(e,l,"103"),104:u(e,l,"104"),105:u(e,l,"105"),107:u(e,l,"107"),108:u(e,l,"108"),109:u(e,l,"109"),110:u(e,l,"110"),112:u(e,l,"112"),113:u(e,l,"113"),114:u(e,l,"114"),115:u(e,l,"115"),116:u(e,l,"116"),118:u(e,l,"118")},emotions:{is_speaking:u(e,l,"is_speaking"),eyes_smile:u(e,l,"eyes_smile")},stress:{stress:u(e,l,"stress",0)}},s=r==null?void 0:r.reduce((i,C)=>(i[C]=u(e,l,C),i),{});return{isSpeakingInput:t,eyesSmileInput:o,visemeInputs:a,riveInputs:d,customInputs:s,visemeMap:n}};import yt from"react";import{jsx as xt}from"react/jsx-runtime";var Ae=yt.createContext(null);function bt({children:e}){return xt(Ae.Provider,{value:{},children:e})}import{jsx as Tt}from"react/jsx-runtime";var Re=St(null);function Mt({inputs:e,children:r,...n}){var C;let{rive:t,isRiveLoaded:o,RiveComponent:a,setImageAsset:d}=Ne(l,{src:"src"in n?n.src:void 0}),s=Ue({rive:"rive"in n?n.rive.rive:t,customInputNames:e}),i=kt(Ae);if(!i)throw new Error("<MascotClient /> must be used within <MascotProvider />");return Tt(Re.Provider,{value:{rive:"rive"in n?n.rive.rive:t,isRiveLoaded:"rive"in n?!0:o,RiveComponent:"rive"in n?(C=n.rive)==null?void 0:C.RiveComponent:a,setImageAsset:"rive"in n&&"setImageAsset"in n.rive?n.rive.setImageAsset:d,...s,...i},children:r})}import{useCallback as It}from"react";import{Loader2 as Pt}from"lucide-react";import{AnimatePresence as Et,motion as _t}from"motion/react";import{useContext as wt}from"react";var j=()=>{let e=wt(Re);if(!e)throw new Error("useMascotClient hook must be used within <MascotClient />");return e};import De from"react";var Ie=()=>{let[e,r]=De.useState(!1);return De.useEffect(()=>{e||r(!0)},[]),e};import{clsx as At}from"clsx";import{twMerge as Rt}from"tailwind-merge";function qe(...e){return Rt(At(e))}import{jsx as ue,jsxs as Lt}from"react/jsx-runtime";function Vt(e){let{isRiveLoaded:r,eyesSmileInput:n,isSpeakingInput:t,customInputs:o,riveInputs:a,RiveComponent:d}=j(),s=Ie(),i=It(()=>{if(!!e.onClick){if(typeof e.onClick!="function")throw new Error("onClick has to be a valid function");e.onClick({inputs:{...o,...a.emotions}})}},[e.onClick,n,t,o]);return e.children?e.children:ue(Ft,{children:ue("div",{className:qe("relative w-full h-full flex items-center justify-center",{"opacity-0":!r||!s,"cursor-pointer":e.onClick&&typeof e.onClick=="function"}),children:ue(d,{role:"img","aria-label":"Character",onClick:i,className:"w-full h-full"})})})}function Ft({children:e}){let{isRiveLoaded:r}=j(),n=Ie();return Lt("div",{className:"relative w-full h-full flex items-center justify-center",children:[ue(Et,{children:r||!n?null:ue(_t.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 inline-flex z-50",children:ue(Pt,{className:"w-12 h-12 animate-spin text-white"})})}),e]})}import{createContext as hn,useContext as Cn,useEffect as ke,useRef as _e,useState as q}from"react";import{RTVIEvent as J}from"@pipecat-ai/client-js";import{RTVIClientAudio as gn,RTVIClientProvider as vn,useRTVIClient as st,useRTVIClientEvent as X,useRTVIClientMediaTrack as yn}from"@pipecat-ai/client-react";import bn from"jszip";import{AnimatePresence as xn,motion as Ve}from"motion/react";import{useEffect as Bt,useState as Ot}from"react";function Se(e){let[r,n]=Ot(null);return Bt(()=>{let t=window.matchMedia(e),o=a=>{n(a.matches)};return t.addEventListener("change",o),n(t.matches),()=>{t.removeEventListener("change",o)}},[e]),r}var Ce=class{constructor(r={}){this.options=r;this.playbackQueue=[];this.isPlaying=!1;this.nextStartTime=0;this.processor=null;this.thresholdFired=!1;this.firstNonZeroFound=!1;this.audioContext=new AudioContext}async setMediaStream(r){try{let n=this.audioContext.createMediaStreamSource(r);await this.audioContext.audioWorklet.addModule("https://mascotbot-seven.vercel.app/worklets/buffer-processor.js"),this.processor=new AudioWorkletNode(this.audioContext,"buffer-processor"),this.processor.port.onmessage=t=>{t.data.data.some(o=>o>0)&&!this.firstNonZeroFound&&(this.firstNonZeroFound=!0),this.firstNonZeroFound&&this.enqueueChunk(t.data)},n.connect(this.processor),this.processor.connect(this.audioContext.destination)}catch{}}enqueueChunk(r){var n;this.playbackQueue.push(r),typeof((n=this.options)==null?void 0:n.onAudioChunkProcessed)=="function"&&this.options.onAudioChunkProcessed(r),this.options.onThresholdExceeded&&this.playbackQueue.length>=(this.options.threshold||0)&&!this.thresholdFired&&(this.thresholdFired=!0,this.options.onThresholdExceeded())}play(){this.isPlaying||(this.isPlaying=!0,this.scheduleChunks())}scheduleChunks(){for(;this.playbackQueue.length>0;){let r=this.playbackQueue.shift();r&&this.playChunk(r)}this.isPlaying&&requestAnimationFrame(()=>this.scheduleChunks())}playChunk(r){let t=r.data.length/1,o=this.audioContext.createBuffer(1,t,this.audioContext.sampleRate);o.getChannelData(0).set(r.data);let a=this.audioContext.createBufferSource();a.buffer=o,a.connect(this.audioContext.destination);let d=Math.max(this.audioContext.currentTime,this.nextStartTime);a.start(d),this.nextStartTime=d+o.duration}pause(){!this.isPlaying||(this.isPlaying=!1,this.audioContext.suspend().then(()=>{console.log("AudioContext suspended.")}))}reset(){console.log("Resetting the audio buffer\u2026"),this.pause(),this.playbackQueue.length=0,this.nextStartTime=0,this.isPlaying=!1,this.thresholdFired=!1,this.firstNonZeroFound=!1,this.processor&&(this.processor.disconnect(),this.processor.port.close(),this.processor=null,console.log("Audio Buffer Processor disconnected and port closed.")),this.audioContext.state!=="closed"&&this.audioContext.close().then(()=>{console.log("AudioContext closed. Reinitializing..."),this.audioContext=new AudioContext})}};import Nt from"@breezystack/lamejs";function He(e,r){let o=new Nt.Mp3Encoder(1,r,128),a=[],d=Ut(e),s=o.encodeBuffer($t(d));a.push(s);let i=o.flush();i.length>0&&a.push(i);let C=new Blob(a,{type:"audio/mpeg"});return{url:URL.createObjectURL(C),blob:C}}function $t(e){let r=new Int16Array(e.length);for(let n=0;n<e.length;n++){let t=Math.max(-1,Math.min(1,e[n]));r[n]=t<0?t*32768:t*32767}return r}function Ut(e){let r=e.reduce((o,a)=>o+a.length,0),n=new Float32Array(r),t=0;for(let o=0;o<e.length;o++)n.set(e[o],t),t+=e[o].length;return n}import{useEffect as zt,useState as Gt}from"react";import{RTVIClient as Zt}from"@pipecat-ai/client-js";import{DailyTransport as Wt}from"@pipecat-ai/daily-transport";import Pe from"lodash";import{useEffect as Dt,useRef as qt}from"react";function Ht(e){let r=qt();return Dt(()=>{r.current=e},[e]),r.current}var ze=Ht;var Kt="http://localhost:3000";function Qt(e,r){return Pe.isEqualWith(e,r,(n,t)=>{if(typeof n=="function"&&typeof t=="function")return n.toString()===t.toString()})}var Ge=e=>{let[r,n]=Gt(null),t=ze(e);return zt(()=>{var s,i,C,p,H,I;if(r&&Qt(e,t))return;console.log("Voice client options:",e);let o=[...e!=null&&e.tts?[{service:"tts",options:[...(s=e.tts)!=null&&s.voice?[{name:"voice",value:e.tts.voice}]:[],...(i=e.tts)!=null&&i.system_prompt?[{name:"system_prompt",value:e.tts.system_prompt}]:[]]}]:[],...e!=null&&e.llm?[{service:"llm",options:[...(C=e.llm)!=null&&C.model?[{name:"model",value:e.llm.model}]:[],...((p=e.llm)==null?void 0:p.system_prompt)||(e==null?void 0:e.system_prompt)?[{name:"system_prompt",value:e.llm.system_prompt||(e==null?void 0:e.system_prompt)}]:[],{name:"run_on_config",value:!0}]}]:[]];console.log("Client config:",o);let a=new Headers;a.append("Content-Type","application/json");let d=new Zt(Pe.merge({transport:new Wt,enableMic:!0,enableCam:!1,params:{baseUrl:`${Kt}/api`,requestData:{...((H=e==null?void 0:e.tts)==null?void 0:H.engine)&&{tts:e.tts.engine},...((I=e==null?void 0:e.llm)==null?void 0:I.engine)&&{llm:e.llm.engine},...o.length>0&&{config:o},apiUrl:e.apiUrl,...e.spreadsheet_id&&{spreadsheet_id:e.spreadsheet_id},...e.mascot_id&&{mascot_id:e.mascot_id}},endpoints:{connect:"/connect",action:"/actions"},headers:a}},Pe.omit(e,["tts","llm","apiUrl","apiKey","spreadsheet_id","mascot_id"])));n(d)},[r,e,t]),r};var me=class{constructor({riveInputs:r,stream:n,transitionDuration:t,threshold:o,onVisemesThreshold:a,setSpeakingState:d}){this._playing=!1;this.startTime=null;this.playbackOffset=0;this.animationFrameId=null;this.transitionDuration=oe;this.originalChunks=[];this._chunks=[];this.playing=this._playing;this.previousVisemeId=null;this.currentStress=0;this.lastPlayedIndex=-1;this.lastStressIndex=-1;this.stream=!1;this.thresholdFired=!1;this.threshold=we;this.onVisemesThreshold=null;this.setSpeakingState=!0;this.chunks=new Proxy(this._chunks,{set:(r,n,t)=>{let o=Reflect.set(r,n,t);return r.length>=this.threshold&&(this==null?void 0:this.onVisemesThreshold)&&!this.thresholdFired&&(this.thresholdFired=!0,this.onVisemesThreshold()),o}});this.stresses=[];this.riveInputs=r,this.stream=n!=null?n:!1,this.transitionDuration=t!=null?t:oe,this.threshold=o!=null?o:we,this.onVisemesThreshold=a,this.setSpeakingState=d!=null?d:!0}play(r){this._playing||(this._playing=!0,this.startTime=performance.now()-this.playbackOffset,r!=null&&r.callback&&r.callback(),console.info("Started playing\u2026"),this.runPlayback())}pause(){!this._playing||(this._playing=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.playbackOffset=this.currentTime())}seek(r){this.pause(),this.playbackOffset=r,this.previousVisemeId=null,this.startTime=null,this.lastPlayedIndex=-1,this.lastStressIndex=-1}reset(){this.pause(),this.run(0),this.setSpeakingState&&(this.riveInputs.emotions.is_speaking.value=!1),this.previousVisemeId=null,this.startTime=null,this.playbackOffset=0,this.animationFrameId=null,this.lastPlayedIndex=-1,this.lastStressIndex=-1,this.chunks.length=0,this._chunks.length=0,this.originalChunks.length=0,this.stresses.length=0,this.thresholdFired=!1}currentTime(){return this.startTime?performance.now()-this.startTime:this.playbackOffset}runPlayback(){if(!this._playing)return;let r=this.currentTime();for(let n=this.lastPlayedIndex+1;n<this._chunks.length;n++){let t=this._chunks[n];if(t.offset<=r)this.run(t.visemeId),this.lastPlayedIndex=n,this.previousVisemeId=t.visemeId;else break}for(let n=this.lastStressIndex+1;n<this.stresses.length;n++){let t=this.stresses[n];if(t.offset<=r)this.animateStress(t.stress),this.lastStressIndex=n;else break}this.stream||this._chunks.length===0&&(console.log("resetting\u2026"),this.reset()),this.animationFrameId=requestAnimationFrame(()=>this.runPlayback())}log(r){console.log(`Viseme ID: ${r} at offset: ${this.currentTime()}`,`Previous Viseme ID: ${this.previousVisemeId}`)}run(r){if(this.riveInputs===null)throw Error("RiveInputs must not be `null`.");if(!(r in le))throw new Error("Unknown viseme id received.");this.setSpeakingState&&!this.riveInputs.emotions.is_speaking.value&&(this.riveInputs.emotions.is_speaking.value=!0);let n={current:le[r],previous:this.previousVisemeId===null?null:le[this.previousVisemeId]},t={current:this.riveInputs.mouth[n.current],previous:n.previous===null?null:this.riveInputs.mouth[n.previous]};t.current&&(t.current.value=this.transitionDuration),t.previous&&(t.previous.value=-this.transitionDuration)}animateStress(r){var C;if(this.riveInputs===null)throw Error("RiveInputs must not be `null`.");let n=.1,t=r,o=[];for(let p=0;p<=t;p++)o.push(p);let a=[];for(let p=t-1;p>=0;p--)a.push(p);let d=o.concat(a),s=0,i=()=>{if(s<d.length){let p=d[s];this.riveInputs.stress.stress.value=p,s++,requestAnimationFrame(i)}};requestAnimationFrame(i),console.log("Stress:",r,"at offset:",this.currentTime(),"Previous stress:",(C=this.stresses[this.lastStressIndex])==null?void 0:C.stress)}};import{useCallback as Jt,useRef as Xt}from"react";import{RTVIEvent as Yt}from"@pipecat-ai/client-js";import{useRTVIClientEvent as en}from"@pipecat-ai/client-react";import{cva as tn}from"class-variance-authority";import nn from"clsx";import{twMerge as rn}from"tailwind-merge";import{jsx as Ze}from"react/jsx-runtime";function We(e){return Ze("svg",{width:"26",height:"26",viewBox:"0 0 22 32",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e,children:Ze("path",{d:"M3.76087 10.9074V20.0926C3.76087 20.5494 3.58909 20.9874 3.28333 21.3104C2.97756 21.6334 2.56285 21.8148 2.13043 21.8148C1.69802 21.8148 1.28331 21.6334 0.977543 21.3104C0.671777 20.9874 0.5 20.5494 0.5 20.0926V10.9074C0.5 10.4506 0.671777 10.0126 0.977543 9.68961C1.28331 9.36663 1.69802 9.18519 2.13043 9.18519C2.56285 9.18519 2.97756 9.36663 3.28333 9.68961C3.58909 10.0126 3.76087 10.4506 3.76087 10.9074ZM7.56522 0C7.1328 0 6.71809 0.181448 6.41233 0.504427C6.10656 0.827407 5.93478 1.26546 5.93478 1.72222V29.2778C5.93478 29.7345 6.10656 30.1726 6.41233 30.4956C6.71809 30.8186 7.1328 31 7.56522 31C7.99764 31 8.41234 30.8186 8.71811 30.4956C9.02387 30.1726 9.19565 29.7345 9.19565 29.2778V1.72222C9.19565 1.26546 9.02387 0.827407 8.71811 0.504427C8.41234 0.181448 7.99764 0 7.56522 0ZM13 4.59259C12.5676 4.59259 12.1529 4.77404 11.8471 5.09702C11.5413 5.42 11.3696 5.85805 11.3696 6.31481V24.6852C11.3696 25.1419 11.5413 25.58 11.8471 25.903C12.1529 26.226 12.5676 26.4074 13 26.4074C13.4324 26.4074 13.8471 26.226 14.1529 25.903C14.4587 25.58 14.6304 25.1419 14.6304 24.6852V6.31481C14.6304 5.85805 14.4587 5.42 14.1529 5.09702C13.8471 4.77404 13.4324 4.59259 13 4.59259ZM18.4348 9.18519C18.0024 9.18519 17.5877 9.36663 17.2819 9.68961C16.9761 10.0126 16.8043 10.4506 16.8043 10.9074V20.0926C16.8043 20.5494 16.9761 20.9874 17.2819 21.3104C17.5877 21.6334 18.0024 21.8148 18.4348 21.8148C18.8672 21.8148 19.2819 21.6334 19.5877 21.3104C19.8934 20.9874 20.0652 20.5494 20.0652 20.0926V10.9074C20.0652 10.4506 19.8934 10.0126 19.5877 9.68961C19.2819 9.36663 18.8672 9.18519 18.4348 9.18519ZM23.8696 6.88889C23.4371 6.88889 23.0224 7.07034 22.7167 7.39332C22.4109 7.7163 22.2391 8.15435 22.2391 8.61111V22.3889C22.2391 22.8457 22.4109 23.2837 22.7167 23.6067C23.0224 23.9297 23.4371 24.1111 23.8696 24.1111C24.302 24.1111 24.7167 23.9297 25.0225 23.6067C25.3282 23.2837 25.5 22.8457 25.5 22.3889V8.61111C25.5 8.15435 25.3282 7.7163 25.0225 7.39332C24.7167 7.07034 24.302 6.88889 23.8696 6.88889Z",fill:"#080808"})})}import{jsx as Ke}from"react/jsx-runtime";function Qe(e){return Ke("svg",{width:"28",height:"10",viewBox:"0 0 28 10",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e,children:Ke("path",{d:"M14.0004 0.0507812C15.6196 0.0507812 17.175 0.166972 18.6668 0.399353C20.1585 0.631733 21.5078 0.991548 22.7147 1.4788C23.9216 1.96605 24.9036 2.59198 25.6607 3.35658C26.1704 3.86632 26.5602 4.43603 26.8301 5.06571C27.1074 5.68789 27.2386 6.37753 27.2236 7.13464C27.2011 8.09415 26.92 8.83627 26.3803 9.361C26.1629 9.57089 25.9118 9.73206 25.6269 9.8445C25.3496 9.94945 25.046 9.97193 24.7162 9.91197L20.6008 9.21482C20.2859 9.16235 20.0161 9.08739 19.7912 8.98994C19.5663 8.89249 19.3827 8.77255 19.2402 8.63012C19.0603 8.45022 18.9366 8.22533 18.8692 7.95547C18.8017 7.68561 18.7642 7.37452 18.7567 7.0222L18.7455 5.87529C18.738 5.71787 18.678 5.57919 18.5656 5.45925C18.5056 5.39928 18.4381 5.35431 18.3632 5.32432C18.2957 5.28684 18.232 5.26061 18.172 5.24561C17.7822 5.13317 17.22 5.04697 16.4854 4.987C15.7508 4.91953 14.9224 4.8858 14.0004 4.8858C13.0784 4.8858 12.2463 4.92328 11.5042 4.99824C10.7696 5.0657 10.2111 5.14441 9.82881 5.23437C9.76884 5.24936 9.69763 5.2756 9.61517 5.31308C9.54021 5.34306 9.47649 5.39179 9.42402 5.45925C9.29659 5.59418 9.23287 5.73661 9.23287 5.88653V7.0222C9.23287 7.37452 9.19914 7.68561 9.13167 7.95547C9.06421 8.22533 8.93677 8.45022 8.74937 8.63012C8.46451 8.91498 8.01475 9.10988 7.40006 9.21482L3.22845 9.92321C2.90612 9.97568 2.61002 9.95319 2.34016 9.85574C2.0778 9.7508 1.84541 9.59713 1.64302 9.39473C1.37316 9.13237 1.16701 8.80628 1.02459 8.41648C0.889656 8.02668 0.810946 7.60315 0.788458 7.14589C0.750977 6.38878 0.859671 5.69913 1.11454 5.07695C1.36941 4.44727 1.75546 3.87382 2.2727 3.35658C3.02981 2.59947 4.01555 1.97729 5.22993 1.49004C6.4443 1.00279 7.80111 0.642977 9.30033 0.410597C10.8071 0.17072 12.3738 0.0507812 14.0004 0.0507812Z",fill:"black"})})}import{jsx as je}from"react/jsx-runtime";function Je(e){return je("svg",{width:"18",height:"24",viewBox:"0 0 18 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e,children:je("path",{d:"M0.953125 11.7981V9.51552C0.953125 9.28313 1.03558 9.08449 1.2005 8.91957C1.36541 8.75466 1.56406 8.6722 1.79644 8.6722C2.03632 8.6722 2.23871 8.75466 2.40363 8.91957C2.56855 9.08449 2.651 9.28313 2.651 9.51552V11.7306C2.651 13.005 2.91337 14.1219 3.4381 15.0814C3.96283 16.0409 4.7012 16.7868 5.65321 17.319C6.60522 17.8437 7.72215 18.1061 9.00399 18.1061C10.2858 18.1061 11.399 17.8437 12.3435 17.319C13.2955 16.7868 14.0339 16.0409 14.5586 15.0814C15.0834 14.1219 15.3457 13.005 15.3457 11.7306V9.51552C15.3457 9.28313 15.4282 9.08449 15.5931 8.91957C15.758 8.75466 15.9604 8.6722 16.2003 8.6722C16.4327 8.6722 16.6313 8.75466 16.7962 8.91957C16.9612 9.08449 17.0436 9.28313 17.0436 9.51552V11.7981C17.0436 13.2673 16.74 14.5717 16.1328 15.7111C15.5331 16.8505 14.6936 17.765 13.6141 18.4547C12.5347 19.1368 11.2791 19.5379 9.84731 19.6578V22.2777H14.0189C14.2588 22.2777 14.4612 22.3602 14.6261 22.5251C14.791 22.69 14.8735 22.8924 14.8735 23.1323C14.8735 23.3647 14.791 23.5633 14.6261 23.7282C14.4612 23.8931 14.2588 23.9756 14.0189 23.9756H3.97782C3.73794 23.9756 3.53555 23.8931 3.37063 23.7282C3.20572 23.5633 3.12326 23.3647 3.12326 23.1323C3.12326 22.8924 3.20572 22.69 3.37063 22.5251C3.53555 22.3602 3.73794 22.2777 3.97782 22.2777H8.14943V19.6578C6.71766 19.5379 5.46206 19.1368 4.38261 18.4547C3.30317 17.765 2.45985 16.8505 1.85266 15.7111C1.25297 14.5717 0.953125 13.2673 0.953125 11.7981ZM9.00399 15.6886C8.25437 15.6886 7.59846 15.5162 7.03625 15.1714C6.47404 14.8265 6.03551 14.3505 5.72068 13.7433C5.40584 13.1287 5.24842 12.4203 5.24842 11.6182V4.0958C5.24842 3.29371 5.40584 2.58907 5.72068 1.98189C6.03551 1.3672 6.47404 0.887448 7.03625 0.542625C7.59846 0.197802 8.25437 0.0253906 9.00399 0.0253906C9.74611 0.0253906 10.3983 0.197802 10.9605 0.542625C11.5302 0.887448 11.9687 1.3672 12.2761 1.98189C12.5909 2.58907 12.7483 3.29371 12.7483 4.0958V11.6182C12.7483 12.4203 12.5909 13.1287 12.2761 13.7433C11.9687 14.3505 11.5302 14.8265 10.9605 15.1714C10.3983 15.5162 9.74611 15.6886 9.00399 15.6886Z",fill:"black"})})}import{jsx as Xe}from"react/jsx-runtime";function Ye(e){return Xe("svg",{width:"21",height:"24",viewBox:"0 0 21 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e,children:Xe("path",{d:"M2.28681 11.7727V9.49012C2.28681 9.25774 2.36926 9.0591 2.53418 8.89418C2.6991 8.72927 2.89774 8.64681 3.13012 8.64681C3.37 8.64681 3.5724 8.72927 3.73731 8.89418C3.90223 9.0591 3.98468 9.25774 3.98468 9.49012V11.7052C3.98468 12.9796 4.24705 14.0965 4.77178 15.056C5.29651 16.0155 6.03488 16.7614 6.98689 17.2936C7.9389 17.8183 9.05583 18.0807 10.3377 18.0807C10.9074 18.0807 11.4434 18.0245 11.9456 17.912C12.4553 17.7996 12.9276 17.6384 13.3624 17.4285L14.5655 18.6429C14.0782 18.9203 13.5498 19.1452 12.9801 19.3176C12.4179 19.4825 11.8182 19.5874 11.181 19.6324V22.2523H15.3526C15.5925 22.2523 15.7949 22.3348 15.9598 22.4997C16.1247 22.6646 16.2072 22.867 16.2072 23.1069C16.2072 23.3393 16.1247 23.5379 15.9598 23.7028C15.7949 23.8677 15.5925 23.9502 15.3526 23.9502H5.3115C5.07163 23.9502 4.86923 23.8677 4.70431 23.7028C4.5394 23.5379 4.45694 23.3393 4.45694 23.1069C4.45694 22.867 4.5394 22.6646 4.70431 22.4997C4.86923 22.3348 5.07163 22.2523 5.3115 22.2523H9.48311V19.6324C8.05134 19.5125 6.79574 19.1114 5.7163 18.4293C4.63685 17.7396 3.79353 16.8251 3.18634 15.6857C2.58665 14.5463 2.28681 13.2419 2.28681 11.7727ZM16.2859 14.089C16.5482 13.3544 16.6794 12.5598 16.6794 11.7052V9.49012C16.6794 9.25774 16.7619 9.0591 16.9268 8.89418C17.0917 8.72927 17.2941 8.64681 17.534 8.64681C17.7664 8.64681 17.965 8.72927 18.1299 8.89418C18.2948 9.0591 18.3773 9.25774 18.3773 9.49012V11.7727C18.3773 13.107 18.1187 14.3176 17.6014 15.4046L16.2859 14.089ZM10.3377 15.6632C9.58806 15.6632 8.93214 15.4908 8.36993 15.146C7.80772 14.8011 7.3692 14.3251 7.05436 13.718C6.73952 13.1033 6.5821 12.3949 6.5821 11.5928V10.6483L11.4171 15.4833C11.0948 15.6032 10.735 15.6632 10.3377 15.6632ZM10.3377 0C9.59555 0 8.94713 0.168663 8.39242 0.50599C7.8377 0.835821 7.39918 1.29683 7.07685 1.88903C6.76201 2.48123 6.59709 3.16712 6.5821 3.94672V4.39649L14.0483 11.8627C14.0633 11.8252 14.0708 11.7839 14.0708 11.739C14.0782 11.6865 14.082 11.6378 14.082 11.5928V4.07041C14.082 3.26832 13.9246 2.56368 13.6097 1.95649C13.3024 1.34181 12.8639 0.862057 12.2942 0.517234C11.732 0.172411 11.0798 0 10.3377 0ZM18.5909 20.7456L1.18487 3.36202C1.01996 3.2046 0.9375 3.00221 0.9375 2.75483C0.9375 2.50746 1.01996 2.30132 1.18487 2.1364C1.35728 1.97149 1.56343 1.88903 1.80331 1.88903C2.04318 1.88903 2.24933 1.97149 2.42174 2.1364L19.8166 19.52C19.9815 19.6849 20.0639 19.8873 20.0639 20.1272C20.0639 20.367 19.9815 20.5732 19.8166 20.7456C19.6516 20.9105 19.4455 20.993 19.1981 20.993C18.9582 20.993 18.7558 20.9105 18.5909 20.7456Z",fill:"black"})})}import{jsx as Ee,jsxs as jt}from"react/jsx-runtime";function et(e){return jt("svg",{width:"130",height:"110",viewBox:"0 0 130 110",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e,children:[Ee("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M54.6904 0.859378H75.0442C85.1356 0.85927 93.2198 0.859184 99.6501 1.59425C106.281 2.35229 111.897 3.95676 116.674 7.69441C118.729 9.30218 120.581 11.1539 122.189 13.2088C125.926 17.986 127.531 23.6016 128.289 30.2329C129.024 36.6632 129.024 44.7475 129.024 54.8389V55.5742C129.024 65.6655 129.024 73.7498 128.289 80.1802C127.531 86.8115 125.926 92.4271 122.189 97.2042C120.581 99.2592 118.729 101.111 116.674 102.719C111.897 106.456 106.281 108.061 99.6501 108.819C93.2198 109.554 85.1355 109.554 75.0441 109.554H54.6905C44.5991 109.554 36.5148 109.554 30.0845 108.819C23.4531 108.061 17.8375 106.456 13.0604 102.719C11.0055 101.111 9.15374 99.2592 7.54597 97.2042C3.80833 92.4271 2.20385 86.8115 1.44581 80.1802C0.710747 73.7499 0.710833 65.6656 0.71094 55.5743V54.8388C0.710833 44.7475 0.710747 36.6632 1.44581 30.2329C2.20385 23.6016 3.80833 17.986 7.54597 13.2088C9.15374 11.1539 11.0055 9.30218 13.0604 7.69441C17.8375 3.95676 23.4531 2.35229 30.0845 1.59425C36.5148 0.859184 44.5991 0.85927 54.6904 0.859378ZM31.4363 13.4199C25.8842 14.0545 22.738 15.2355 20.3949 17.0687C19.1001 18.0818 17.9333 19.2485 16.9203 20.5433C15.0871 22.8864 13.9061 26.0326 13.2714 31.5847C12.6227 37.26 12.6136 44.6626 12.6136 55.2065C12.6136 65.7505 12.6227 73.1531 13.2714 78.8284C13.9061 84.3805 15.0871 87.5267 16.9203 89.8697C17.9333 91.1645 19.1001 92.3313 20.3949 93.3444C22.738 95.1776 25.8842 96.3585 31.4363 96.9932C37.1115 97.642 44.5141 97.6511 55.0581 97.6511H74.6765C85.2204 97.6511 92.6231 97.642 98.2983 96.9932C103.85 96.3585 106.997 95.1776 109.34 93.3444C110.634 92.3313 111.801 91.1645 112.814 89.8697C114.648 87.5267 115.828 84.3805 116.463 78.8284C117.112 73.1531 117.121 65.7505 117.121 55.2065C117.121 44.6626 117.112 37.26 116.463 31.5847C115.828 26.0326 114.648 22.8864 112.814 20.5433C111.801 19.2485 110.634 18.0818 109.34 17.0687C106.997 15.2355 103.85 14.0545 98.2983 13.4199C92.6231 12.7711 85.2205 12.762 74.6765 12.762H55.0581C44.5142 12.762 37.1115 12.7711 31.4363 13.4199Z",fill:"white",fillOpacity:"0.88"}),Ee("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M42.83 46.7633L34.7133 38.6617L26.3126 47.0939L34.4215 55.1876L26.302 63.3223L34.7341 71.723L42.8458 63.5961L50.9708 71.7059L59.3715 63.2737L51.2544 55.1718L59.3461 47.0649L50.914 38.6642L42.83 46.7633Z",fill:"white",fillOpacity:"0.88"}),Ee("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M86.9629 46.7633L78.8461 38.6617L70.4454 47.0939L78.5543 55.1876L70.4348 63.3223L78.8669 71.723L86.9786 63.5961L95.1036 71.7059L103.504 63.2737L95.3872 55.1718L103.479 47.0649L95.0468 38.6642L86.9629 46.7633Z",fill:"white",fillOpacity:"0.88"})]})}import{jsx as tt}from"react/jsx-runtime";function nt(e){return tt("svg",{width:"25",height:"24",viewBox:"0 0 25 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e,children:tt("path",{d:"M12.5 4.66667V1M17.6944 6.80556L20.3222 4.17778M19.8333 12H23.5M17.6944 17.1944L20.3222 19.8222M12.5 19.3333V23M7.30556 17.1944L4.67778 19.8222M5.16667 12H1.5M7.30556 6.80556L4.67778 4.17778",stroke:"black",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}import{jsx as de,jsxs as cn}from"react/jsx-runtime";function on(...e){return rn(nn(e))}var sn=()=>{let e=Xt(null);return en(Yt.LocalAudioLevel,Jt(r=>{if(e.current){let n=Number(r)*1.75*2;e.current.style.transform=`scale(${Math.max(.1,n)})`}},[])),de("div",{className:"absolute inset-0 bg-green-300 overflow-hidden z-0 rounded-full transition-all scale-0 opacity-50",ref:e})},an=tn("relative aspect-square z-20 transition-all overflow-hidden",{variants:{muted:{true:"animate-pulse"},blocked:{true:""},canTalk:{true:"opacity-1"}}});function rt({muted:e=!1,handleMute:r}){let n=!e;return de("div",{className:"relative z-20 text-white",children:cn(fe,{className:on(an({muted:e,canTalk:n})),onClick:()=>r(),children:[de("div",{className:"relative z-20 transition leading-none",children:n?de(Je,{className:"size-6"}):de(Ye,{className:"size-6"})}),n&&de(sn,{})]})})}import ln from"react";import{cva as un}from"class-variance-authority";import mn from"clsx";import{twMerge as dn}from"tailwind-merge";import{jsx as pn}from"react/jsx-runtime";function ot(...e){return dn(mn(e))}var fn=un(ot("inline-flex items-center justify-center gap-x-2.5 h-16 w-fit p-5 text-lg rounded-[3px] truncate transition","hover:opacity-80","disabled:pointer-events-none disabled:opacity-50"),{variants:{variant:{default:"bg-white text-black",outline:"bg-black/35 border border-white/15 text-white"}},defaultVariants:{variant:"default"}}),fe=ln.forwardRef(({variant:e,className:r,children:n,...t},o)=>pn("button",{className:ot(fn({variant:e}),r),ref:o,...t,children:n}));import{jsx as k,jsxs as Y}from"react/jsx-runtime";var Fe=class{constructor(){this.currentChunkSetOffset=0;this.nextChunkSetOffset=0;this.isFirstResponse=!0;this.initialDelay=75}processChunk(r){var s;let{chunk_progress:n,visemes:t}=r,[o,a]=n.split("/").map(Number);return o===1&&(this.currentChunkSetOffset=this.nextChunkSetOffset,this.isFirstResponse&&(this.currentChunkSetOffset+=this.initialDelay)),this.nextChunkSetOffset+=(s=r==null?void 0:r.chunk_duration_ms)!=null?s:0,t.map(i=>({visemeId:i.visemeId,offset:i.offset+this.currentChunkSetOffset}))}log(r){console.info("Processed Visemes:",r,"\u2013","Next Chunk Set Offset:",this.nextChunkSetOffset)}reset(){this.currentChunkSetOffset=0,this.nextChunkSetOffset=0}disableFirstResponseMode(){this.isFirstResponse=!1}},it=hn(null);function Sn(e){let[r,n]=q(void 0),t=Ge({apiUrl:e.apiUrl,tts:e.tts,llm:e.llm,apiKey:e.apiKey,spreadsheet_id:e.spreadsheet_id,mascot_id:e.mascot_id,enableCam:!1,callbacks:{onGenericMessage:o=>{o&&typeof o=="object"&&"daily_room_id"in o&&n(o.daily_room_id)}}});return ke(()=>{!t||(t.on("disconnected",()=>{n(void 0)}),console.log("MascotCall configuration:",{apiUrl:e.apiUrl,tts:e.tts,llm:e.llm,spreadsheet_id:e.spreadsheet_id,mascot_id:e.mascot_id}))},[t,e.apiUrl,e.tts,e.llm,e.spreadsheet_id,e.mascot_id]),t?k(vn,{client:t,children:k(kn,{...e,roomId:r})}):null}function kn({roomId:e,debug:r,children:n,...t}){let o=st(),a=yn("audio","bot"),{riveInputs:d}=j(),s=_e(null),i=_e(null),C=_e(new Fe),[p,H]=q(!0),[I,M]=q("disconnected"),[pe,P]=q(null),[ge,z]=q(!0),ie=Se("(max-width: 640px)"),[w,O]=q([]),[N,F]=q([]),[A,L]=q([]);function G(){try{s.current&&(s.current.reset(),s.current=null),i.current&&(i.current.reset(),i.current=null)}catch(m){console.error("Error during resource cleanup:",m)}}function ee(){if(!!s.current)try{s.current.reset(),i.current&&i.current.reset(),C.current.reset(),P(null),O([]),L([]),F([])}catch(m){console.error("Error during state reset:",m)}}async function ve(){if(!!o){H(!0);try{o.enableCam(!1),o.enableMic(!0),z(!1),await o.initDevices(),await o.connect()}catch(m){console.error(m),P(m.message||"Unknown error occured"),o.disconnect()}}}async function he(){ee();try{await o.disconnect()}catch(m){console.error("Error during disconnect:",m)}G()}function Me(){z(m=>(o.enableMic(m),!m))}return ke(()=>()=>{console.log("Component unmounting - cleaning up resources"),G()},[]),ke(()=>{if(!!a)try{let m=new MediaStream([a]);return p&&(i.current=new Ce({threshold:0,onThresholdExceeded:()=>{!s.current||s.current.play()},onAudioChunkProcessed(c){F(f=>[...f,c.data])}}),i.current.setMediaStream(m)),s.current=new me({riveInputs:d,stream:!0,transitionDuration:ie?xe:oe,threshold:0,onVisemesThreshold:()=>{var c;if(!!s.current)if(!p||!i.current)try{i.current=new Ce({threshold:0,onThresholdExceeded:()=>{!s.current||s.current.play()},onAudioChunkProcessed(f){F(g=>[...g,f.data])}}),i.current.setMediaStream(m)}catch(f){console.error("Error initializing audio buffer:",f)}else(c=s.current)==null||c.play()}}),()=>{G()}}catch(m){console.error("Error in audio setup:",m)}},[d,a,ie,p]),X(J.BotTtsText,m=>{try{if(O(f=>[...f,m]),!s.current)return;let c=C.current.processChunk(m);s.current.chunks.push(...c),L(f=>[...f,...c])}catch(c){console.error("Error processing TTS chunk:",c)}}),X(J.UserStartedSpeaking,()=>{try{ee()}catch(m){console.error("Error in UserStartedSpeaking:",m)}}),X(J.UserStoppedSpeaking,()=>{try{ee()}catch(m){console.error("Error in UserStoppedSpeaking:",m)}}),X(J.BotStoppedSpeaking,()=>{try{p?(console.log("BotStoppedSpeaking - switching to normal mode after first response"),H(!1),C.current.disableFirstResponseMode(),G()):ee()}catch(m){console.error("Error in BotStoppedSpeaking:",m)}}),ke(()=>()=>{G()},[]),X(J.TransportStateChanged,m=>{M(m),(t==null?void 0:t.onStateChange)&&typeof t.onStateChange=="function"&&t.onStateChange(m)}),X(J.Error,m=>{console.log("Error Event:",m),P(m.type)}),Y(it.Provider,{value:{start:ve,leave:he},children:[pe&&k(Tn,{}),k(gn,{}),r&&Y("div",{className:"fixed bottom-4 right-4 flex flex-col items-end gap-2 z-[100]",children:[k("button",{disabled:!e,className:"w-fit bg-white rounded-full px-4 py-2 text-xs disabled:opacity-50 transition text-black",onClick:()=>{let m=`https://elt1xxmlb5.execute-api.us-east-1.amazonaws.com/prod/archive?daily_room_id=${e}`,c=document.createElement("a");c.style.display="none",c.href=m,c.target="_blank",document.body.appendChild(c),c.click(),document.body.removeChild(c)},children:"Download room archive"}),k("button",{disabled:w.length===0&&A.length===0&&N.length===0,className:"bg-white rounded-full px-4 py-2 text-xs disabled:opacity-50 transition text-black",onClick:async()=>{let m=new bn;if(w.length>0){let h=JSON.stringify(w,null,2);m.file("chunks.json",h)}if(A.length>0){let h=JSON.stringify(A,null,2);m.file("visemes.json",h)}if(N.length>0){let h=He(N,48e3).blob;m.file("audio.mp3",h,{binary:!0})}let c=await m.generateAsync({type:"blob"}),f=URL.createObjectURL(c),g=document.createElement("a");g.style.display="none",g.href=f,g.download=`${e} (${new Date().valueOf()}).zip`,document.body.appendChild(g),g.click(),document.body.removeChild(g),O([]),L([]),F([])},children:"Download last response data"})]}),typeof n=="function"?n({startProps:{onClick:()=>{z(!1),ve()}},endProps:{onClick:he},muteProps:{onClick:Me},state:I,muted:ge}):n]})}function Mn(){let e=st(),r=Cn(it);if(!r)throw new Error("<MascotCallControlPanel /> must be used within <MascotCall />");let{start:n,leave:t}=r,[o,a]=q("disconnected"),[d,s]=q(!0),[i,C]=q(!1),p=["initializing","initialized","authenticating","connecting","connected"],H=["ready"];X(J.TransportStateChanged,P=>{a(P),P!=="ready"&&C(!1)}),X(J.BotTtsText,()=>{C(!0)});function I(){s(P=>(e.enableMic(P),!P))}let M=H.includes(o)&&i,pe=p.includes(o)||H.includes(o)&&!i;return k("div",{className:"flex items-center justify-center gap-4",children:k("div",{children:k(xn,{mode:"popLayout",children:M?Y(Ve.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:1},className:"flex gap-x-5",children:[k(rt,{muted:d,handleMute:I}),Y(fe,{className:"bg-[#FF0000]",onClick:t,children:[k(Qe,{}),"End Call"]})]},"mic"):pe?k(Ve.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:1},children:Y(fe,{"aria-disabled":!0,className:"pointer-events-none opacity-50",children:[k(nt,{className:"animate-spin"}),"Connecting"]})},"connecting"):k(Ve.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:1},children:Y(fe,{onClick:()=>{s(!1),n()},children:[k(We,{}),"Start Voice Mode"]})},"start")})})})}function Tn(){return k("div",{className:"grid place-items-center w-full h-full",children:Y("div",{className:"grid place-items-center gap-y-6 w-[230px] text-center",children:[k(et,{}),Y("div",{className:"space-y-2",children:[k("h2",{className:"text-white text-3xl font-black",children:"Something went wrong"}),k("p",{className:"text-white opacity-40 text-lg",children:"Please check your mascot settings and subscription"})]})]})})}import at from"react";var Le=e=>{let{riveInputs:r}=j(),n=at.useRef(null),t=Se("(max-width: 640px)");at.useEffect(()=>{n.current=new me({riveInputs:r,transitionDuration:t?xe:oe,threshold:0,setSpeakingState:e==null?void 0:e.setSpeakingState})},[r,t,e==null?void 0:e.setSpeakingState]);function o(p){!n.current||n.current.chunks.push(...p)}function a(p){!n.current||n.current.stresses.push(...p)}function d(){!n.current||n.current.play()}function s(p){!n.current||n.current.seek(p)}function i(){!n.current||n.current.pause()}function C(){!n.current||n.current.reset()}return{add:o,stress:a,play:d,seek:s,pause:i,reset:C}};var wn=()=>({...j()});import{useCallback as se,useEffect as ct,useRef as W,useState as Be}from"react";var An={AmericanFemaleHeart:"af_heart",AmericanFemaleAlloy:"af_alloy",AmericanFemaleAoede:"af_aoede",AmericanFemaleBella:"af_bella",AmericanFemaleJessica:"af_jessica",AmericanFemaleKore:"af_kore",AmericanFemaleNicole:"af_nicole",AmericanFemaleNova:"af_nova",AmericanFemaleRiver:"af_river",AmericanFemaleSarah:"af_sarah",AmericanFemaleSky:"af_sky",AmericanMaleSanta:"am_santa",AmericanMaleAdam:"am_adam",AmericanMaleEcho:"am_echo",AmericanMaleEric:"am_eric",AmericanMaleFenrir:"am_fenrir",AmericanMaleLiam:"am_liam",AmericanMaleMichael:"am_michael",AmericanMaleOnyx:"am_onyx",AmericanMalePuck:"am_puck",BritishFemaleAlice:"bf_alice",BritishFemaleEmma:"bf_emma",BritishFemaleIsabella:"bf_isabella",BritishFemaleLily:"bf_lily",BritishMaleDaniel:"bm_daniel",BritishMaleFable:"bm_fable",BritishMaleGeorge:"bm_george",BritishMaleLewis:"bm_lewis"},Rn=e=>{let{apiKey:r,bufferSize:n=1,enableTimingEvents:t=!0,apiEndpoint:o="/api/visemes-audio",useProxy:a=!0}=e,d=Le(),[s,i]=Be(!1),[C,p]=Be(!1),[H,I]=Be(null),M=W(null),pe=W(new Map),P=W([]),ge=W(0),z=W(!1),ie=W(0),w=W(0),O=W(null),N=W(null),F=W(null);ct(()=>{let c=async()=>{try{if(!M.current){if(t&&console.log("Creating new AudioContext on component mount"),M.current=new(window.AudioContext||window.webkitAudioContext),M.current.state==="suspended")try{await M.current.resume(),t&&console.log("AudioContext resumed on mount")}catch(h){console.warn("Could not resume AudioContext on mount, will try again when needed:",h)}f()}}catch(h){console.error("Error initializing AudioContext on mount:",h)}},f=()=>{if(!!M.current)try{F.current&&(F.current.stop(),F.current.disconnect());let h=M.current.createOscillator(),T=M.current.createGain();T.gain.value=0,h.connect(T),T.connect(M.current.destination),h.start(),F.current=h,t&&console.log("Silent oscillator created to keep AudioContext warm")}catch(h){console.error("Error creating silent oscillator:",h)}};c();let g=setInterval(f,1e4);return()=>{if(clearInterval(g),F.current)try{F.current.stop(),F.current.disconnect()}catch{}}},[t]);let A=se((c=!1)=>{t&&console.log("Cleaning up speech resources"),(!z.current||c)&&(P.current.forEach(f=>{try{f.stop()}catch{}}),P.current=[],pe.current.clear(),d.reset(),i(!1),ge.current=0,z.current=!1,ie.current=0,O.current=null,N.current=null)},[d,t]),L=se(async()=>{try{if(M.current||(M.current=new(window.AudioContext||window.webkitAudioContext),t&&console.log("Created new AudioContext in initAudioContext call")),M.current.state==="suspended")try{await M.current.resume(),t&&console.log("Resumed AudioContext in initAudioContext call")}catch(c){console.error("Error resuming AudioContext:",c)}return M.current}catch(c){throw console.error("Error initializing AudioContext:",c),c}},[t]),G=se(async(c,f)=>{let g=performance.now(),h=await L(),T=performance.now();t&&console.log(`[Client Timing PCM] initAudioContext took: ${(T-g).toFixed(1)}ms`);try{let b;if(typeof atob=="function"&&typeof Uint8Array=="function"){let S=atob(c);b=new Uint8Array(S.length);for(let _=0;_<S.length;_++)b[_]=S.charCodeAt(_)}else{let S=window.atob(c);b=new Uint8Array(S.length);for(let _=0;_<S.length;_++)b[_]=S.charCodeAt(_)}let y=performance.now(),R=performance.now();t&&console.log(`[Client Timing PCM] Base64 decode took: ${(R-y).toFixed(1)}ms`);let x=performance.now(),B=new Int16Array(b.buffer),v=performance.now();t&&console.log(`[Client Timing PCM] Int16Array creation took: ${(v-x).toFixed(1)}ms`);let E=performance.now(),ye=new Float32Array(B.length),te=1/32768;for(let S=0;S<B.length;S++)ye[S]=B[S]*te;let Z=performance.now();t&&console.log(`[Client Timing PCM] Float32Array conversion took: ${(Z-E).toFixed(1)}ms`);let ne=performance.now(),$=h.createBuffer(1,ye.length,f);$.getChannelData(0).set(ye);let ae=performance.now();t&&console.log(`[Client Timing PCM] createBuffer + setData took: ${(ae-ne).toFixed(1)}ms`);let U=performance.now();return t&&console.log(`[Client Timing PCM] Total pcmToAudioBuffer took: ${(U-g).toFixed(1)}ms`),$}catch(b){throw console.error("Error converting PCM to AudioBuffer:",b),b}},[L]),ee=se(async(c,f,g)=>{try{let h=await L();if(h.state!=="running")try{await h.resume()}catch(x){console.error("Error resuming AudioContext:",x)}let T=h.createBufferSource();T.buffer=c;let b=h.createGain();b.gain.value=1,T.connect(b),b.connect(h.destination),P.current.push(T);let y=[...g].sort((x,B)=>x.offset-B.offset);if(f>0){let x=h.currentTime*1e3-ie.current;if(y.length>0){let B=Math.min(...y.map(E=>E.offset)),v=x-B;for(let E=0;E<y.length;E++)y[E].offset+=v;t&&console.log(`Adjusted viseme timing by ${v.toFixed(1)}ms for sequence ${f}`)}}d.add(y),t&&console.log(`Added ${y.length} visemes to mascot for sequence ${f}`),f===0?(i(!0),p(!1),ie.current=h.currentTime*1e3,t&&console.log(`Starting mascot animation for sequence ${f}`),d.play()):t&&console.log(`Continuing mascot animation for sequence ${f}`);let R=performance.now();if(console.log(`[Client Timing Playback] Calling source.start(0): ${(R-w.current).toFixed(1)}ms`),T.start(0),z.current=!0,ge.current=f,f===0&&t){let x=performance.now()-w.current;console.log(`Time to playback: ${x.toFixed(1)}ms`),console.log(`Timing summary:
        - First audio received: ${O.current?O.current.toFixed(1):"N/A"}ms
        - First viseme received: ${N.current?N.current.toFixed(1):"N/A"}ms
        - Time to playback: ${x.toFixed(1)}ms`)}return new Promise(x=>{T.onended=()=>{t&&console.log(`Audio playback ended naturally for sequence ${f}`),x(!0)};let B=setTimeout(()=>{t&&console.log(`Audio playback completed after ${c.duration} seconds for sequence ${f}`),x(!0)},c.duration*1e3+100);T.onended=()=>{clearTimeout(B),t&&console.log(`Audio playback ended naturally for sequence ${f}`),x(!0)}})}catch(h){return console.error("Error playing audio:",h),!1}},[L,d,t]),ve=c=>{let f=[],g=c;for(;;){let h=g.indexOf(`

`);if(h===-1)break;let T=g.substring(0,h);f.push(T),g=g.substring(h+2)}return{complete:f,remainder:g}},he=se(async c=>{let f=performance.now(),g=f-w.current;if(t&&console.log(`Response received after ${g.toFixed(1)}ms from button press`),!c.body)return I("Response body is null"),!1;let h=c.body.getReader(),T=new TextDecoder,b="",y=new Map,R=new Map,x=0,B=0,v=0,E=!1,ye=await L(),te=!1,Z=null,ne=0,$=null,be=null,ae=async()=>{if(E){t&&console.log(`Already playing sequence ${v}, waiting to finish`);return}if(!y.has(v)){t&&console.log(`Waiting for audio data for sequence ${v}`);return}if(!R.has(v)){let D=y.get(v);v===0&&!Z&&!te&&(te=!0,t&&console.log(`Pre-processing audio for sequence ${v} while waiting for visemes`),Z=G(D.data,D.sample_rate)),t&&console.log(`Waiting for visemes for sequence ${v}`);return}v===0&&t&&console.log("Starting playback immediately for first chunk"),E=!0;let S=y.get(v),_=R.get(v);t&&console.log(`Playing sequence ${v} with ${_.length} visemes`);try{let D;Z&&v===0?(D=await Z,Z=null,te=!1,t&&console.log(`Using pre-processed audio buffer for sequence ${v}`),$=performance.now(),console.log(`[Client Timing] Using pre-processed AudioBuffer (conversion time: ${$&&$?($-$).toFixed(1):"N/A"}ms)`)):($=performance.now(),console.log(`[Client Timing] Starting pcmToAudioBuffer: ${($-w.current).toFixed(1)}ms`),D=await G(S.data,S.sample_rate),be=performance.now(),console.log(`[Client Timing] Finished pcmToAudioBuffer: ${(be-w.current).toFixed(1)}ms (duration: ${(be-$).toFixed(1)}ms)`));let re=performance.now();console.log(`[Client Timing] Calling playAudioBuffer: ${(re-w.current).toFixed(1)}ms`),await ee(D,v,_);let ce=performance.now();if(console.log(`[Client Timing] Finished awaiting playAudioBuffer: ${(ce-w.current).toFixed(1)}ms (duration: ${(ce-re).toFixed(1)}ms)`),v++,E=!1,y.has(v)&&!Z&&!te){let K=y.get(v);t&&console.log(`Pre-processing audio for next sequence ${v}`),Z=G(K.data,K.sample_rate)}ae()}catch(D){console.error(`Error playing sequence ${v}:`,D),E=!1,Z=null,te=!1}};try{for(;;){let{done:U,value:S}=await h.read();if(U)break;if(ne===null){ne=performance.now(),console.log(`[Client Timing] First SSE chunk received: ${(ne-w.current).toFixed(1)}ms`);let re=ne-w.current;t&&console.log(`First chunk received after ${re.toFixed(1)}ms from button press (${(ne-f).toFixed(1)}ms after response)`)}b+=T.decode(S,{stream:!0});let D=ve(b);b=D.remainder;for(let re of D.complete)try{if(re.startsWith("data: ")){let ce=re.slice(6).trim(),K=JSON.parse(ce);if(K.type==="audio"){let V=K,In=V.sequence;O.current===null&&(O.current=performance.now()-w.current,console.log(`First audio received after ${O.current.toFixed(1)}ms`)),x++,y.set(V.sequence,V),t&&console.log(`Received audio chunk for sequence ${V.sequence} (${x} total)`),ae()}else if(K.type==="visemes"){let V=K;t&&(console.log(`Received visemes event for audio sequence ${V.audio_sequence}, viseme sequence ${V.viseme_sequence}`),N.current===null&&(N.current=performance.now()-w.current,console.log(`First viseme received after ${N.current.toFixed(1)}ms`))),B++,t&&console.log(`Received viseme chunk for sequence ${V.audio_sequence} (${B} total)`),R.has(V.audio_sequence)||R.set(V.audio_sequence,[]),R.get(V.audio_sequence).push(...V.visemes),ae()}else if(K.type==="error")return I(K.error),A(!0),!1}}catch(ce){console.error("Error parsing SSE event:",ce)}}if(y.size===0)return I("No audio data received from server"),A(!0),!1;{let U=Math.max(...Array.from(y.keys()));for(t&&console.log(`Stream ended. Highest sequence: ${U}, current: ${v}`);v<=U;)E||await ae(),await new Promise(S=>setTimeout(S,50));return i(!1),z.current=!1,!0}}catch(U){return console.error("Error processing stream:",U),I(U instanceof Error?U.message:"Error processing stream"),!1}},[n,A,G,ee,t,L]),Me=se(async(c,f)=>{w.current=performance.now();let g=a?o:o.startsWith("/")?"https://api.mascotbot.com/v1/visemes-audio":o;t&&console.log(`Using endpoint: ${g}, proxy: ${a}`);let h={"Content-Type":"application/json"};a||(h.Authorization=`Bearer ${r}`);let T=fetch(g,{method:"POST",headers:h,body:JSON.stringify({text:c,voice:f})});t&&console.log("Fetch initiated immediately, now handling setup in parallel");try{let b=(async()=>{var R;try{if(A(!0),d.reset(),((R=M.current)==null?void 0:R.state)!=="running")try{await L()}catch(x){console.error("Error initializing audio context:",x)}t&&(console.log("Speech requested, recording start time"),O.current=null,N.current=null),p(!0),I(null),z.current=!0,t&&console.log(`Starting speech for text: "${c.substring(0,30)}${c.length>30?"...":""}" with voice: ${f}`)}catch(x){console.error("Error in parallel setup:",x)}})(),y=await T;if(await b,!y.ok){let R=await y.text();throw console.error("API error response:",R),new Error(`API error: ${y.status} ${y.statusText}`)}return t&&console.log("API response received, processing stream"),await he(y)}catch(b){return console.error("Error in speech:",b),I(b instanceof Error?b.message:"Unknown error"),A(!0),!1}finally{p(!1)}},[r,o,a,A,t,L,d,he]),m=se(()=>{A(!0)},[A]);return ct(()=>()=>{z.current||A(!1)},[A]),{speak:Me,stopSpeaking:m,isSpeaking:s,isLoading:C,error:H}};export{Sn as MascotCall,Mn as MascotCallControlPanel,Mt as MascotClient,bt as MascotProvider,Vt as MascotRive,An as MascotVoices,wn as useMascot,Le as useMascotPlayback,Te as useMascotRive,Rn as useMascotSpeech};
